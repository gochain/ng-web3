{"version":3,"file":"gochain-ng-web3.umd.js","sources":["ng://gochain-ng-web3/lib/gochain-ng-web3.service.ts"],"sourcesContent":["/*CORE*/\nimport {Injectable} from '@angular/core';\nimport {BehaviorSubject, Observable, throwError} from 'rxjs';\nimport {fromPromise} from 'rxjs/internal-compatibility';\nimport {catchError, map, tap} from 'rxjs/operators';\n/*WEB3*/\nimport Web3 from 'web3';\nimport {Account} from 'web3-eth-accounts';\nimport {SignedTransaction, TransactionReceipt} from 'web3-core';\n\nclass InitConfig {\n  rpcUrl: string;\n}\n\ninterface IGochainWeb3Service {\n  initialize(config: InitConfig);\n\n  initializePlugin();\n\n  activatePlugin();\n\n  getPluginAccountAddress();\n\n  createAccount();\n\n  /*openAccount(privateKey: string);*/\n\n  closeAccount();\n\n  /*getBalance();*/\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class GochainNgWeb3Service implements IGochainWeb3Service {\n  private _metamaskInstalled: boolean;\n  private _metamaskConfigured: boolean;\n  private _metamaskActivated: boolean;\n  private _config: InitConfig;\n  private _gochainNetId: number;\n\n  set metamaskInstalled(value: boolean) {\n    this._metamaskInstalled = value;\n    this.metamaskInstalled$.next(value);\n  }\n\n  set metamaskConfigured(value: boolean) {\n    this._metamaskConfigured = value;\n    this.metamaskConfigured$.next(value);\n  }\n\n  set metamaskActivated(value: boolean) {\n    this._metamaskActivated = value;\n    this.metamaskActivated$.next(value);\n  }\n\n  metamaskInstalled$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(null);\n  metamaskConfigured$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(null);\n  metamaskActivated$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(null);\n  ready$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(null);\n  accountBalance: string;\n  gochainWeb3: Web3;\n  pluginWeb3: Web3;\n  accountAddress: string;\n  account: Account;\n\n  get web3(): Web3 {\n    if (this._metamaskConfigured && this._metamaskInstalled) {\n      return this.pluginWeb3;\n    }\n    return this.gochainWeb3;\n  }\n\n  constructor() {\n  }\n\n  initialize(config: InitConfig): Observable<boolean> {\n    this._config = config;\n    if (!config.rpcUrl) {\n      return throwError('rpc url hasn\\'t been provided');\n    }\n    this.gochainWeb3 = new Web3(new Web3.providers.HttpProvider(config.rpcUrl), null, {transactionConfirmationBlocks: 1});\n\n    return fromPromise(this.gochainWeb3.eth.net.getId()).pipe(\n      catchError((e: Error) => {\n        return throwError('Can\\'t get GoChain network id');\n      }),\n      map(v => !!v),\n    );\n  }\n\n  initializePlugin(): Observable<any> {\n    if (!this.gochainWeb3) {\n      return throwError('initialize first');\n    }\n    if (!this._gochainNetId) {\n      return throwError('gochain network id is not provided');\n    }\n\n    this.pluginWeb3 = new Web3(Web3.givenProvider, null, {transactionConfirmationBlocks: 1});\n\n    if (!this.pluginWeb3.currentProvider) {\n      this.metamaskInstalled = false;\n      this.metamaskConfigured = false;\n      return throwError('metamask is not installed');\n    }\n\n    return fromPromise(this.pluginWeb3.eth.net.getId()).pipe(\n      catchError((e: Error) => {\n        this.metamaskInstalled = true;\n        this.metamaskConfigured = false;\n        return throwError('Metamask installed but not configured properly - can\\'t get network id from Metamask');\n      }),\n      map((metamaskNetID: number) => {\n        if (this._gochainNetId !== metamaskNetID) {\n          this.metamaskInstalled = true;\n          this.metamaskConfigured = false;\n          return throwError(`Metamask installed but misconfigured - network ID mismatch (must use GoChain ${this._gochainNetId} - e.g. by pointing to ${this._config.rpcUrl})`);\n        }\n        this.metamaskInstalled = true;\n        this.metamaskConfigured = true;\n        this.getPluginAccountAddress();\n        return true;\n      }),\n    );\n  }\n\n  activatePlugin(): Observable<any> {\n    return fromPromise((window as any).ethereum.enable()).pipe(\n      catchError((e) => {\n        this.metamaskActivated = false;\n        return throwError('Access haven\\'t been granted');\n      }),\n      tap(() => {\n        this.metamaskActivated = true;\n      }),\n    );\n  }\n\n  getPluginAccountAddress(): void {\n    fromPromise(this.pluginWeb3.eth.getAccounts()).subscribe((accounts: string[]) => {\n      this.accountAddress = accounts[0];\n    });\n  }\n\n  createAccount() {\n    return !!this.web3 ? this.web3.eth.accounts.create() : null;\n  }\n\n  /*protected _openAccount(privateKey: string) {\n    if (privateKey.length === 64 && privateKey.indexOf('0x') !== 0) {\n      privateKey = '0x' + privateKey;\n    }\n    if (privateKey.length !== 66) {\n      throw Error('Given private key is not valid');\n    }\n    try {\n      this.account = this.gochainWeb3.eth.accounts.privateKeyToAccount(privateKey);\n    } catch (e) {\n      throw e;\n    }\n    return this.account;\n  }*/\n\n  closeAccount() {\n    this.account = null;\n    this.accountAddress = null;\n    this.accountBalance = null;\n  }\n\n  /*getBalance() {\n    return fromPromise(this.gochainWeb3.eth.getBalance(this.account.address)).pipe(\n      map((balance: string) => {\n        this.accountBalance = this.gochainWeb3.utils.fromWei(balance, 'ether').toString();\n        return this.accountBalance;\n      }),\n    );\n  }*/\n\n  sendSignedTx(signed: SignedTransaction): Observable<TransactionReceipt> {\n    return fromPromise(this.gochainWeb3.eth.sendSignedTransaction(signed.rawTransaction));\n  }\n\n  isAddress(address: string) {\n    return this.gochainWeb3.utils.isAddress(address);\n  }\n}\n"],"names":["BehaviorSubject","throwError","fromPromise","catchError","map","tap","Injectable"],"mappings":"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"}